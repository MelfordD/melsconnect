{% extends "base.html" %}

{% block title %}Book Appointment - {{ business.name }}{% endblock %}

{% block content %}
<div class="gradient-bg text-white py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <h1 class="text-3xl font-bold mb-2">Book an Appointment</h1>
        <p class="opacity-90">{{ business.name }}</p>
    </div>
</div>

<div class="max-w-2xl mx-auto px-4 py-12">
    <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100">
        <form method="POST" id="bookingForm">
            {{ form.hidden_tag() }}
            
            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-medium mb-2">Select Service *</label>
                <select name="service_id" id="service_id" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
                    {% for service in services %}
                    <option value="{{ service.id }}" data-duration="{{ service.duration_minutes }}" {% if service.id == selected_service_id %}selected{% endif %}>
                        {{ service.name }} - ${{ "%.2f"|format(service.price) }} ({{ service.duration_minutes }} min)
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-medium mb-2">Select Date *</label>
                <input type="date" name="booking_date" id="booking_date" value="{{ selected_date }}" min="{{ now().strftime('%Y-%m-%d') if now is defined else '' }}" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
                {% for error in form.booking_date.errors %}
                    <p class="text-red-500 text-sm mt-1">{{ error }}</p>
                {% endfor %}
            </div>
            
            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-medium mb-2">Select Time *</label>
                <select name="booking_time" id="booking_time" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
                    <option value="">Select a date first</option>
                </select>
                {% for error in form.booking_time.errors %}
                    <p class="text-red-500 text-sm mt-1">{{ error }}</p>
                {% endfor %}
            </div>
            
            <hr class="my-6 border-gray-200">
            
            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-medium mb-2">Your Name *</label>
                {{ form.customer_name(class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none", placeholder="John Doe") }}
                {% for error in form.customer_name.errors %}
                    <p class="text-red-500 text-sm mt-1">{{ error }}</p>
                {% endfor %}
            </div>
            
            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-medium mb-2">Phone Number *</label>
                {{ form.customer_phone(class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none", placeholder="(555) 123-4567") }}
                {% for error in form.customer_phone.errors %}
                    <p class="text-red-500 text-sm mt-1">{{ error }}</p>
                {% endfor %}
            </div>
            
            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-medium mb-2">Email (optional)</label>
                {{ form.customer_email(class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none", placeholder="you@example.com") }}
                {% for error in form.customer_email.errors %}
                    <p class="text-red-500 text-sm mt-1">{{ error }}</p>
                {% endfor %}
            </div>
            
            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-medium mb-2">Notes (optional)</label>
                {{ form.notes(class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none", rows="3", placeholder="Any special requests or notes...") }}
            </div>
            
            <button type="submit" class="w-full bg-primary text-white py-4 rounded-lg font-semibold hover:bg-secondary transition">
                Book Appointment
            </button>
        </form>
        
        <p class="text-center text-gray-500 text-sm mt-6">
            <a href="{{ url_for('booking.public_page', slug=business.slug) }}" class="hover:text-primary">&larr; Back to {{ business.name }}</a>
        </p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const serviceSelect = document.getElementById('service_id');
    const dateInput = document.getElementById('booking_date');
    const timeSelect = document.getElementById('booking_time');
    const slug = '{{ business.slug }}';
    
    const today = new Date().toISOString().split('T')[0];
    dateInput.setAttribute('min', today);
    
    function loadTimeSlots() {
        const serviceId = serviceSelect.value;
        const date = dateInput.value;
        
        if (!serviceId || !date) {
            timeSelect.innerHTML = '<option value="">Select a date first</option>';
            return;
        }
        
        timeSelect.innerHTML = '<option value="">Loading...</option>';
        
        fetch(`/b/${slug}/slots?service_id=${serviceId}&date=${date}`)
            .then(response => response.json())
            .then(data => {
                if (data.slots.length === 0) {
                    timeSelect.innerHTML = '<option value="">No available slots</option>';
                } else {
                    timeSelect.innerHTML = data.slots.map(slot => 
                        `<option value="${slot}">${slot}</option>`
                    ).join('');
                }
            })
            .catch(error => {
                timeSelect.innerHTML = '<option value="">Error loading slots</option>';
            });
    }
    
    serviceSelect.addEventListener('change', loadTimeSlots);
    dateInput.addEventListener('change', loadTimeSlots);
    
    if (dateInput.value) {
        loadTimeSlots();
    }
</script>
{% endblock %}
